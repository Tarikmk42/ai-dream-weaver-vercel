<script>
    // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==========
    const API_BASE = window.location.origin;
    const SD_API = `${API_BASE}/api/sd-proxy`;
    const LLM_API = `${API_BASE}/api/llm-proxy`;
    const HEALTH_API = `${API_BASE}/api/health`;
    
    console.log('API Configuration:', {
        API_BASE,
        SD_API,
        LLM_API,
        HEALTH_API,
        location: window.location.href
    });

    // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
    document.addEventListener('DOMContentLoaded', async () => {
        console.log('AI Dream Weaver initializing...');
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ API
        await testAPI();
        
        // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
        setTimeout(() => {
            const loader = document.getElementById('loader');
            if (loader) {
                loader.style.opacity = '0';
                setTimeout(() => {
                    loader.style.display = 'none';
                    showNotification('üöÄ –ò–≥—Ä–∞ –≥–æ—Ç–æ–≤–∞! –ù–∞—á–Ω–∏—Ç–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ.');
                }, 500);
            }
        }, 1000);
        
        // –§–æ–∫—É—Å –Ω–∞ input
        const input = document.getElementById('user-input');
        if (input) {
            setTimeout(() => input.focus(), 200);
        }
    });

    // ========== API –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï ==========
    async function testAPI() {
        try {
            console.log('Testing API endpoints...');
            
            // Test Health
            const healthRes = await fetch(HEALTH_API);
            console.log('Health API:', healthRes.status, await healthRes.json());
            
            // Test SD API
            const sdRes = await fetch(SD_API, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: 'test' })
            });
            console.log('SD API:', sdRes.status);
            
            // Test LLM API
            const llmRes = await fetch(LLM_API, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: 'test',
                    messages: [{ role: 'user', content: 'Hello' }]
                })
            });
            console.log('LLM API:', llmRes.status);
            
        } catch (error) {
            console.warn('API test failed:', error);
            showNotification('‚ö†Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
        }
    }

    // ========== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
    async function handleUserAction() {
        const input = document.getElementById('user-input');
        const btn = document.getElementById('action-btn');
        const text = input?.value.trim();
        
        if (!text) {
            showNotification('‚úèÔ∏è –í–≤–µ–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ!');
            return;
        }
        
        if (btn) btn.disabled = true;
        addStoryText(`<i>–í—ã: "${text}"</i>`);
        
        try {
            // –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç LLM
            const story = await askLLM(text);
            addStoryText(story);
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            setTimeout(async () => {
                try {
                    await generateImage(text);
                } catch (error) {
                    console.warn('Image generation failed:', error);
                }
            }, 500);
            
        } catch (error) {
            console.error('Action failed:', error);
            addStoryText(`–û—à–∏–±–∫–∞: ${error.message}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.`);
        } finally {
            if (btn) btn.disabled = false;
            if (input) {
                input.value = '';
                input.focus();
            }
        }
    }

    async function askLLM(prompt) {
        const response = await fetch(LLM_API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: 'local-model',
                messages: [{ role: 'user', content: prompt }],
                temperature: 0.7,
                max_tokens: 300
            })
        });
        
        if (!response.ok) {
            throw new Error(`LLM API error: ${response.status}`);
        }
        
        const data = await response.json();
        return data.choices[0].message.content;
    }

    async function generateImage(prompt) {
        showNotification('üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...');
        
        const response = await fetch(SD_API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                prompt: prompt + ", fantasy art, dream world",
                steps: 20,
                width: 512,
                height: 384
            })
        });
        
        if (!response.ok) {
            throw new Error(`SD API error: ${response.status}`);
        }
        
        const data = await response.json();
        showNotification('‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ!');
        
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ Phaser
        console.log('Image generated:', data);
    }

    // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
    function addStoryText(text) {
        const panel = document.getElementById('story-text');
        if (panel) {
            panel.innerHTML += '<br><br>' + text;
            panel.scrollTop = panel.scrollHeight;
        }
    }

    function showNotification(text, duration = 3000) {
        const notification = document.getElementById('notification');
        if (!notification) return;
        
        notification.textContent = text;
        notification.style.display = 'block';
        
        setTimeout(() => {
            notification.style.display = 'none';
        }, duration);
    }

    // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ô –î–û–°–¢–£–ü ==========
    window.AIDreamWeaver = {
        testAPI,
        handleUserAction,
        showNotification
    };
</script>

