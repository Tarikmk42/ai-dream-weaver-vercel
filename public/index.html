<script>
    // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø API ==========
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏ –¥–ª—è Vercel
    const SD_API = '/api/sd-proxy';
    const LLM_API = '/api/llm-proxy';
    const HEALTH_API = '/api/health';
    
    console.log('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API:', { SD_API, LLM_API, HEALTH_API });
    console.log('–¢–µ–∫—É—â–∏–π URL:', window.location.href);

    // ========== –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò–ì–†–´ ==========
    let game = null;
    let sceneImage = null;
    let currentImageKey = 'generated';
    let isGenerating = false;
    let battleAnimationActive = false;

    // –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
    const gameState = {
        history: [],
        inventory: [
            '–ó–µ–ª—å–µ –∑–¥–æ—Ä–æ–≤—å—è (+30 HP)',
            '–ú–∞–≥–∏—á–µ—Å–∫–∏–π —Å–≤–∏—Ç–æ–∫',
            '–ö–ª—é—á –æ—Ç —Å—Ç–∞—Ä–æ–≥–æ —Ö—Ä–∞–º–∞',
            '–ö–∞—Ä—Ç–∞ —Å–Ω–æ–≤'
        ],
        player: {
            hp: 100,
            maxHp: 100,
            attack: 10,
            defense: 5,
            level: 1,
            exp: 0,
            gold: 50,
            mana: 50,
            maxMana: 50
        },
        currentBattle: null,
        quests: {
            main: {
                title: "–ü—Ä–æ–±—É–¥–∏—Ç—å –•—Ä–∞–Ω–∏—Ç–µ–ª—è –°–Ω–æ–≤",
                objectives: [
                    { id: 1, text: "–ù–∞–π—Ç–∏ –ö—Ä–∞—Å–Ω—ã–π –ö—Ä–∏—Å—Ç–∞–ª–ª –≤ –û–≥–Ω–µ–Ω–Ω—ã—Ö –ü–µ—â–µ—Ä–∞—Ö", done: false, keyword: "–∫—Ä–∞—Å–Ω—ã–π –∫—Ä–∏—Å—Ç–∞–ª–ª" },
                    { id: 2, text: "–ù–∞–π—Ç–∏ –°–∏–Ω–∏–π –ö—Ä–∏—Å—Ç–∞–ª–ª –≤ –ó–∞—Ç–æ–ø–ª–µ–Ω–Ω–æ–º –•—Ä–∞–º–µ", done: false, keyword: "—Å–∏–Ω–∏–π –∫—Ä–∏—Å—Ç–∞–ª–ª" },
                    { id: 3, text: "–ù–∞–π—Ç–∏ –ó–µ–ª—ë–Ω—ã–π –ö—Ä–∏—Å—Ç–∞–ª–ª –≤ –õ–µ—Å—É –î—É—Ö–æ–≤", done: false, keyword: "–∑–µ–ª–µ–Ω—ã–π –∫—Ä–∏—Å—Ç–∞–ª–ª" },
                    { id: 4, text: "–ü—Ä–æ–≤–µ—Å—Ç–∏ —Ä–∏—Ç—É–∞–ª –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏—è –≤ –ó–∞–ø—Ä–µ—Ç–Ω–æ–π –ë–∞—à–Ω–µ", done: false, keyword: "—Ä–∏—Ç—É–∞–ª" }
                ],
                completed: false
            },
            side: [
                { id: 101, title: "–ü–æ–º–æ—á—å –ø–æ—Ç–µ—Ä—è–Ω–Ω–æ–º—É –¥—É—Ö—É", completed: false },
                { id: 102, title: "–°–æ–±—Ä–∞—Ç—å 5 –º–∞–≥–∏—á–µ—Å–∫–∏—Ö –≥—Ä–∏–±–æ–≤", completed: false }
            ]
        },
        discoveredLocations: ['–õ–µ—Å –°–Ω–æ–≤'],
        achievements: []
    };

    // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
    document.addEventListener('DOMContentLoaded', async () => {
        console.log('AI Dream Weaver –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è...');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º URL
        if (window.location.hostname.includes('vercel.app')) {
            console.log('–ó–∞–ø—É—â–µ–Ω–æ –Ω–∞ Vercel');
        } else if (window.location.hostname.includes('localhost')) {
            console.log('–ó–∞–ø—É—â–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ');
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        if (window.Telegram && window.Telegram.WebApp) {
            try {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                Telegram.WebApp.enableClosingConfirmation();
                
                console.log('Telegram Web App –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
                const user = Telegram.WebApp.initDataUnsafe?.user;
                if (user) {
                    gameState.player.name = user.first_name || '–ü—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫';
                    addStoryText(`<span style="color:#8a2fff">‚ú® –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${gameState.player.name}!</span>`);
                }
            } catch (error) {
                console.log('Telegram Web App –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω:', error);
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        loadGame();

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Phaser
        initializePhaser();

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        setupEventListeners();

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
        updateUI();

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ API
        await testAllEndpoints();

        // –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑—á–∏–∫
        setTimeout(() => {
            document.getElementById('loader').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loader').style.display = 'none';
                showNotification('üåå –ú–∏—Ä —Å–Ω–æ–≤ –≥–æ—Ç–æ–≤! –ù–∞—á–Ω–∏—Ç–µ —Å–≤–æ–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ...');
            }, 500);
        }, 1500);
    });

    // ========== –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï API ==========
    async function testAllEndpoints() {
        console.log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API endpoints...');
        
        try {
            // –¢–µ—Å—Ç 1: Health endpoint
            console.log('–¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ /api/health');
            const healthResponse = await fetch(HEALTH_API);
            const healthData = await healthResponse.json();
            console.log('Health API –æ—Ç–≤–µ—Ç:', healthData);
            
            if (healthResponse.ok) {
                showNotification('‚úÖ API –ø–æ–¥–∫–ª—é—á–µ–Ω–æ!');
            } else {
                showNotification('‚ö†Ô∏è Health API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ');
            }
            
            // –¢–µ—Å—Ç 2: LLM endpoint
            console.log('–¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ /api/llm-proxy');
            try {
                const llmResponse = await fetch(LLM_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'test',
                        messages: [{ role: 'user', content: '–ü—Ä–∏–≤–µ—Ç' }]
                    })
                });
                
                if (llmResponse.ok) {
                    console.log('LLM API —Ä–∞–±–æ—Ç–∞–µ—Ç');
                } else {
                    console.warn('LLM API –æ—à–∏–±–∫–∞:', llmResponse.status);
                }
            } catch (llmError) {
                console.warn('LLM API —Ç–µ—Å—Ç –Ω–µ —É–¥–∞–ª—Å—è:', llmError.message);
            }
            
            // –¢–µ—Å—Ç 3: SD endpoint
            console.log('–¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ /api/sd-proxy');
            try {
                const sdResponse = await fetch(SD_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: 'test image'
                    })
                });
                
                if (sdResponse.ok) {
                    console.log('SD API —Ä–∞–±–æ—Ç–∞–µ—Ç');
                } else {
                    console.warn('SD API –æ—à–∏–±–∫–∞:', sdResponse.status);
                }
            } catch (sdError) {
                console.warn('SD API —Ç–µ—Å—Ç –Ω–µ —É–¥–∞–ª—Å—è:', sdError.message);
            }
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API:', error);
            showNotification('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API');
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
            addStoryText(`<span style="color:#ffaa00">
                ‚ö†Ô∏è <b>–í–Ω–∏–º–∞–Ω–∏–µ:</b> API –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ.<br>
                –ò–≥—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ.<br>
                –ü—Ä–æ–±–ª–µ–º–∞: ${error.message}
            </span>`);
        }
    }

    // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø PHASER ==========
    function initializePhaser() {
        const config = {
            type: Phaser.AUTO,
            parent: 'game-container',
            width: window.innerWidth,
            height: window.innerHeight,
            scene: {
                preload: preload,
                create: create,
                update: update
            },
            scale: {
                mode: Phaser.Scale.RESIZE,
                autoCenter: Phaser.Scale.CENTER_BOTH
            },
            transparent: true,
            backgroundColor: '#0a0a1a'
        };

        game = new Phaser.Game(config);
    }

    function preload() {
        console.log('Phaser: Preload');
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º placeholder –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        const placeholder = `
            <svg width="512" height="384" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#0a0a1a;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#1a1a2e;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <rect width="100%" height="100%" fill="url(#grad1)"/>
                <text x="256" y="192" font-family="Arial" font-size="24" fill="#ffffff" text-anchor="middle" opacity="0.5">
                    AI Dream Weaver
                </text>
            </svg>
        `;
        
        const placeholderURL = 'data:image/svg+xml;base64,' + btoa(placeholder);
        this.load.image('placeholder', placeholderURL);
    }

    function create() {
        console.log('Phaser: Create');
        
        // –°–æ–∑–¥–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ-–∑–∞–≥–ª—É—à–∫—É
        sceneImage = this.add.image(
            this.scale.width / 2,
            this.scale.height / 2,
            'placeholder'
        ).setScale(0.7).setAlpha(0.3);

        // –§–æ–∫—É—Å –Ω–∞ input
        setTimeout(() => {
            const input = document.getElementById('user-input');
            if (input) input.focus();
        }, 100);
    }

    function update() {
        // –ê–Ω–∏–º–∞—Ü–∏–∏ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
    }

    // ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ==========
    function setupEventListeners() {
        // –ö–Ω–æ–ø–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è
        const actionBtn = document.getElementById('action-btn');
        const userInput = document.getElementById('user-input');
        
        if (actionBtn) {
            actionBtn.addEventListener('click', handleUserAction);
        }
        
        if (userInput) {
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleUserAction();
                }
            });
        }

        // –ö–Ω–æ–ø–∫–∏ –±–æ—è
        document.getElementById('btn-attack')?.addEventListener('click', () => handleBattle('attack'));
        document.getElementById('btn-item')?.addEventListener('click', () => handleBattle('item'));
        document.getElementById('btn-flee')?.addEventListener('click', () => handleBattle('flee'));

        // –ö–Ω–æ–ø–∫–∏ –ø–∞–Ω–µ–ª–µ–π
        document.getElementById('toggle-inventory')?.addEventListener('click', () => togglePanel('inventory-panel'));
        document.getElementById('toggle-quests')?.addEventListener('click', () => togglePanel('quest-panel'));

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        window.addEventListener('beforeunload', saveGame);
    }

    // ========== –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –ò–ì–†–´ ==========
    async function handleUserAction() {
        if (isGenerating) return;

        const input = document.getElementById('user-input');
        const btn = document.getElementById('action-btn');
        const userText = input?.value.trim();

        if (!userText) {
            showNotification('‚úèÔ∏è –í–≤–µ–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ!');
            return;
        }

        // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
        if (btn) btn.disabled = true;
        isGenerating = true;

        // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –∏–≥—Ä–æ–∫–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é
        addStoryText(`<i style="color:#88ff88">üë§ –í—ã: "${userText}"</i>`);

        // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞
        clearChoiceButtons();

        try {
            // –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å API
            const story = await askLLM(userText);
            gameState.history.push(story);
            addStoryText(story);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞
            addChoiceButtons(story);
            
            // –ü—Ä–æ–±—É–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            setTimeout(() => {
                generateImageForStory(userText).catch(() => {
                    console.log('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ');
                });
            }, 500);
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–µ–π—Å—Ç–≤–∏—è:', error);
            
            // Fallback –ª–æ–≥–∏–∫–∞
            const fallbackResponses = [
                `–í—ã "${userText.toLowerCase()}" –≤ –º–∏—Ä–µ —Å–Ω–æ–≤. –ß—Ç–æ –±—É–¥–µ—Ç–µ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ?`,
                `"${userText}" - –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π –≤—ã–±–æ—Ä. –ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤–∞—à–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ.`,
                `–ú–∏—Ä —Å–Ω–æ–≤ –æ—Ç–∫–ª–∏–∫–∞–µ—Ç—Å—è –Ω–∞ –≤–∞—à–µ –¥–µ–π—Å—Ç–≤–∏–µ "${userText.substring(0, 30)}..."`
            ];
            
            const randomResponse = fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
            addStoryText(randomResponse);
            
            // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞
            addChoiceButtons("1. –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –¥–∞–ª—å—à–µ\n2. –û—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è –≤–æ–∫—Ä—É–≥\n3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å\n4. –ò—Å–∫–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏");
            
            showNotification('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É');
            
        } finally {
            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            if (btn) btn.disabled = false;
            isGenerating = false;
            if (input) {
                input.value = '';
                input.focus();
            }
            
            saveGame();
            updateUI();
        }
    }

    async function askLLM(userAction) {
        try {
            const response = await fetch(LLM_API, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    model: 'local-model',
                    messages: [
                        {
                            role: 'system',
                            content: '–¢—ã –º–∞—Å—Ç–µ—Ä –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –≤ —Ñ—ç–Ω—Ç–µ–∑–∏-–º–∏—Ä–µ —Å–Ω–æ–≤. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–æ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–π –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–µ–π—Å—Ç–≤–∏–π.'
                        },
                        {
                            role: 'user',
                            content: `–ò–≥—Ä–æ–∫ –≤ —Ñ—ç–Ω—Ç–µ–∑–∏-–º–∏—Ä–µ —Å–Ω–æ–≤. –î–µ–π—Å—Ç–≤–∏–µ: "${userAction}". –û–ø–∏—à–∏ —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç (2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ 3 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –¥–µ–π—Å—Ç–≤–∏–π (–ø—Ä–æ–Ω—É–º–µ—Ä—É–π 1. 2. 3.).`
                        }
                    ]
                })
            });

            if (!response.ok) {
                throw new Error(`LLM API error: ${response.status}`);
            }

            const data = await response.json();
            return data.choices?.[0]?.message?.content || '–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç –Ω–µ–π—Ä–æ—Å–µ—Ç–∏.';

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ LLM:', error);
            throw error;
        }
    }

    async function generateImageForStory(prompt) {
        if (isGenerating) return;
        
        isGenerating = true;
        showNotification('üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...');

        try {
            const response = await fetch(SD_API, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    prompt: prompt + ", fantasy art, dream world, magical",
                    steps: 20,
                    width: 512,
                    height: 384
                })
            });

            if (!response.ok) {
                throw new Error(`SD API error: ${response.status}`);
            }

            const data = await response.json();
            
            // –°–æ–∑–¥–∞–µ–º fallback –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            createFallbackImage(prompt);
            
            showNotification('‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ!');

        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
            createFallbackImage(prompt);
        } finally {
            isGenerating = false;
        }
    }

    function createFallbackImage(prompt) {
        if (!game || !game.scene || !game.scene.scenes[0]) return;
        
        const scene = game.scene.scenes[0];
        const canvas = document.createElement('canvas');
        canvas.width = 512;
        canvas.height = 384;
        const ctx = canvas.getContext('2d');
        
        // –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Ñ–æ–Ω
        const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        gradient.addColorStop(0, '#0a0a1a');
        gradient.addColorStop(1, '#1a1a2e');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // –¢–µ–∫—Å—Ç
        ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
        ctx.font = 'bold 30px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('AI Dream Weaver', canvas.width / 2, canvas.height / 2);
        
        ctx.fillStyle = 'rgba(138, 47, 255, 0.3)';
        ctx.font = '16px Arial';
        ctx.fillText(prompt.substring(0, 50), canvas.width / 2, canvas.height / 2 + 40);
        
        // –°–æ–∑–¥–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ canvas
        const img = new Image();
        img.onload = () => {
            if (scene.textures.exists('fallback')) {
                scene.textures.get('fallback').setSource(img);
            } else {
                scene.textures.addImage('fallback', img);
            }
            
            if (sceneImage) {
                sceneImage.setTexture('fallback');
                sceneImage.setAlpha(0.7);
            }
        };
        img.src = canvas.toDataURL();
    }

    // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
    function togglePanel(panelId) {
        const panel = document.getElementById(panelId);
        if (!panel) return;
        
        panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    }

    function addStoryText(text) {
        const panel = document.getElementById('story-text');
        if (panel) {
            panel.innerHTML += '<br><br>' + text;
            panel.scrollTop = panel.scrollHeight;
        }
    }

    function clearChoiceButtons() {
        document.querySelectorAll('.choice-btn').forEach(btn => btn.remove());
    }

    function addChoiceButtons(storyText) {
        clearChoiceButtons();
        
        const choices = storyText.match(/\d\.\s+([^\n]+)/g);
        if (choices && choices.length > 0) {
            choices.forEach((choice, idx) => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.textContent = choice.replace(/^\d\.\s+/, '').trim();
                
                btn.onclick = () => {
                    const input = document.getElementById('user-input');
                    if (input) {
                        input.value = btn.textContent;
                        handleUserAction();
                    }
                };
                
                document.body.appendChild(btn);
            });
        }
    }

    function showNotification(text, duration = 3000) {
        const notification = document.getElementById('notification');
        if (!notification) return;
        
        notification.textContent = text;
        notification.style.display = 'block';
        
        setTimeout(() => {
            notification.style.display = 'none';
        }, duration);
    }

    function updateUI() {
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ HP
        const hpPercent = (gameState.player.hp / gameState.player.maxHp) * 100;
        const hpFill = document.getElementById('player-hp-fill');
        if (hpFill) {
            hpFill.style.width = hpPercent + '%';
            hpFill.className = hpPercent < 30 ? 'hp-fill danger' : 'hp-fill';
            hpFill.querySelector('.hp-text').textContent = `${Math.round(hpPercent)}%`;
        }
        
        document.getElementById('hp-value').textContent = `${gameState.player.hp}/${gameState.player.maxHp}`;
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–æ–≤
        document.getElementById('player-level').textContent = gameState.player.level;
        document.getElementById('player-attack').textContent = gameState.player.attack;
        document.getElementById('player-defense').textContent = gameState.player.defense;
        document.getElementById('player-exp').textContent = gameState.player.exp;
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
        const invList = document.getElementById('inventory-list');
        if (invList) {
            invList.innerHTML = gameState.inventory.map(item => 
                `<li>${item}</li>`
            ).join('');
        }
    }

    function saveGame() {
        try {
            localStorage.setItem('dreamWeaverSave', JSON.stringify(gameState));
            console.log('–ò–≥—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
        } catch (error) {
            console.warn('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
        }
    }

    function loadGame() {
        try {
            const saved = localStorage.getItem('dreamWeaverSave');
            if (saved) {
                const parsed = JSON.parse(saved);
                Object.assign(gameState, parsed);
                console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
            }
        } catch (error) {
            console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
        }
    }

    // ========== –°–ò–°–¢–ï–ú–ê –ë–û–Ø (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è) ==========
    async function handleBattle(action) {
        // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –±–æ—è
        showNotification(`‚öîÔ∏è –ë–æ–π: ${action}`);
    }

    // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ô –î–û–°–¢–£–ü ==========
    window.AIDreamWeaver = {
        gameState,
        saveGame,
        loadGame,
        showNotification,
        testAllEndpoints
    };

    console.log('AI Dream Weaver –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
</script>
