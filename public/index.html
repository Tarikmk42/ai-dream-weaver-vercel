<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Dream Weaver</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background: #0a0a1a; color: #fff; font-family: Arial; overflow: hidden; touch-action: manipulation; height: 100vh; width: 100vw; }
        #game-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #game-container canvas { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 100%; max-height: 100%; object-fit: contain; }
        .ui-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; pointer-events: none; z-index: 100; padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); }
        .story-container { flex: 1; max-height: 35vh; background: rgba(0, 0, 30, 0.95); backdrop-filter: blur(10px); border-bottom: 2px solid #4a6fff; padding: 15px; margin: 10px; border-radius: 20px; overflow-y: auto; pointer-events: auto; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5); }
        .story-text { font-size: 16px; line-height: 1.5; margin: 0; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.8); }
        .input-container { background: rgba(0, 0, 20, 0.9); backdrop-filter: blur(15px); border-top: 2px solid #8a2fff; padding: 15px; margin: 10px; border-radius: 20px; display: flex; gap: 10px; pointer-events: auto; box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5); }
        #user-input { flex: 1; padding: 15px 20px; font-size: 16px; background: rgba(255, 255, 255, 0.1); color: #fff; border: 2px solid #4a6fff; border-radius: 15px; outline: none; min-height: 50px; }
        #action-btn { padding: 0 25px; background: linear-gradient(135deg, #4a6fff, #8a2fff); color: white; border: none; border-radius: 15px; font-size: 18px; font-weight: bold; cursor: pointer; min-width: 80px; }
        #action-btn:disabled { background: #555; cursor: not-allowed; }
        .side-panel { position: fixed; top: 50%; transform: translateY(-50%); width: 280px; max-width: 85vw; background: rgba(0, 0, 30, 0.95); backdrop-filter: blur(15px); border: 2px solid #4a6fff; border-radius: 20px; padding: 15px; overflow-y: auto; pointer-events: auto; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); display: none; }
        #inventory-panel { left: 10px; max-height: 70vh; }
        #quest-panel { right: 10px; max-height: 70vh; }
        .toggle-panel-btn { position: fixed; top: 50%; transform: translateY(-50%); width: 40px; height: 100px; background: rgba(74, 111, 255, 0.8); border: none; border-radius: 0 10px 10px 0; color: white; font-size: 24px; cursor: pointer; z-index: 101; display: flex; align-items: center; justify-content: center; }
        #toggle-inventory { left: 0; border-radius: 0 15px 15px 0; }
        #toggle-quests { right: 0; border-radius: 15px 0 0 15px; }
        #battle-ui { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 500px; background: rgba(139, 0, 0, 0.95); backdrop-filter: blur(15px); padding: 20px; border-radius: 25px; text-align: center; display: none; pointer-events: auto; z-index: 200; border: 3px solid #ff4444; box-shadow: 0 10px 30px rgba(255, 0, 0, 0.3); }
        .battle-btn { margin: 8px; padding: 15px 20px; font-size: 16px; background: linear-gradient(135deg, #ff6600, #ff3300); color: #fff; border: none; border-radius: 15px; cursor: pointer; flex: 1; min-width: 100px; font-weight: bold; }
        .hp-bar { height: 25px; background: rgba(255, 255, 255, 0.1); border-radius: 12px; overflow: hidden; position: relative; }
        .hp-fill { height: 100%; background: linear-gradient(90deg, #00ff88, #00cc66); border-radius: 12px; width: 100%; transition: width 0.5s; position: relative; }
        .hp-fill.danger { background: linear-gradient(90deg, #ff5555, #cc0000); }
        .choice-btn { display: block; margin: 10px auto; padding: 15px; background: linear-gradient(135deg, #3366ff, #2244cc); color: #fff; border: none; border-radius: 15px; cursor: pointer; width: 90%; max-width: 400px; font-size: 16px; font-weight: bold; pointer-events: auto; box-shadow: 0 5px 15px rgba(51, 102, 255, 0.3); }
        @media (max-height: 700px) { .story-container { max-height: 30vh; padding: 10px; } .story-text { font-size: 14px; } .input-container { padding: 10px; } #user-input { padding: 12px 15px; font-size: 15px; min-height: 45px; } #action-btn { padding: 0 20px; font-size: 16px; min-width: 70px; } .side-panel { width: 250px; padding: 12px; } }
        @media (max-height: 600px) { .story-container { max-height: 25vh; } .story-text { font-size: 13px; } }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 4px; } ::-webkit-scrollbar-thumb { background: #4a6fff; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="game-container"></div>
    <div class="ui-container">
        <div class="story-container">
            <div id="story-text" class="story-text"><strong>AI Dream Weaver</strong><br>–¢—ã –≤ –º–∏—Ä–µ —Å–Ω–æ–≤. –û–ø–∏—à–∏ —Å–≤–æ–µ –ø–µ—Ä–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ...</div>
        </div>
        <div class="input-container">
            <input type="text" id="user-input" placeholder="–ß—Ç–æ –¥–µ–ª–∞—Ç—å? (–Ω–∞–ø—Ä–∏–º–µ—Ä: –æ—Å–º–æ—Ç—Ä—é—Å—å –≤–æ–∫—Ä—É–≥)" autocomplete="off">
            <button id="action-btn">‚ñ∂</button>
        </div>
    </div>
    <button class="toggle-panel-btn" id="toggle-inventory">üéí</button>
    <button class="toggle-panel-btn" id="toggle-quests">üìú</button>
    <div id="inventory-panel" class="side-panel">
        <h3>üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
        <ul id="inventory-list"><li>–ó–µ–ª—å–µ –∑–¥–æ—Ä–æ–≤—å—è</li></ul>
        <div style="margin: 15px 0;">
            <div style="display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 5px;"><span>–ó–¥–æ—Ä–æ–≤—å–µ</span><span id="hp-value">100/100</span></div>
            <div class="hp-bar"><div id="player-hp-fill" class="hp-fill" style="width: 100%"><div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-weight: bold; text-shadow: 1px 1px 3px rgba(0,0,0,0.8);">100%</div></div></div>
        </div>
        <div id="player-stats" style="text-align: center; margin-top: 15px; font-size: 14px; color: #8a2fff;">–£—Ä.1 | –ê—Ç–∫:10 | –ó–∞—â:5</div>
    </div>
    <div id="quest-panel" class="side-panel">
        <h3>üìú –ö–≤–µ—Å—Ç—ã</h3>
        <div id="quest-log">
            <div style="margin-bottom: 15px;"><strong style="color: #FFD700;">–ì–ª–∞–≤–Ω—ã–π –∫–≤–µ—Å—Ç:</strong><br>–ü—Ä–æ–±—É–¥–∏—Ç—å –•—Ä–∞–Ω–∏—Ç–µ–ª—è –°–Ω–æ–≤</div>
            <div style="font-size: 14px;"><div style="margin-left: 10px;">‚Ä¢ –ù–∞–π—Ç–∏ –ö—Ä–∞—Å–Ω—ã–π –ö—Ä–∏—Å—Ç–∞–ª–ª</div><div style="margin-left: 10px;">‚Ä¢ –ù–∞–π—Ç–∏ –°–∏–Ω–∏–π –ö—Ä–∏—Å—Ç–∞–ª–ª</div><div style="margin-left: 10px;">‚Ä¢ –ù–∞–π—Ç–∏ –ó–µ–ª—ë–Ω—ã–π –ö—Ä–∏—Å—Ç–∞–ª–ª</div><div style="margin-left: 10px;">‚Ä¢ –ü—Ä–æ–≤–µ—Å—Ç–∏ —Ä–∏—Ç—É–∞–ª</div></div>
        </div>
    </div>
    <div id="battle-ui">
        <h2 id="enemy-title" style="margin: 0 0 20px 0; color: #FFEB3B;">‚öîÔ∏è –ë–û–ô!</h2>
        <div style="margin: 15px 0;">
            <div style="display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 5px;"><span id="enemy-name">–í—Ä–∞–≥</span><span id="enemy-hp-value">100/100</span></div>
            <div class="hp-bar"><div id="enemy-hp-fill" class="hp-fill" style="width: 100%"><div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-weight: bold; text-shadow: 1px 1px 3px rgba(0,0,0,0.8);">100%</div></div></div>
        </div>
        <div style="margin: 15px 0;">
            <div style="display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 5px;"><span>–¢–≤–æ—ë HP</span><span id="player-battle-hp">100/100</span></div>
            <div class="hp-bar"><div id="player-battle-hp-fill" class="hp-fill" style="width: 100%"><div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-weight: bold; text-shadow: 1px 1px 3px rgba(0,0,0,0.8);">100%</div></div></div>
        </div>
        <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 15px;">
            <button class="battle-btn" id="btn-attack">üó°Ô∏è –ê—Ç–∞–∫–æ–≤–∞—Ç—å</button>
            <button class="battle-btn" id="btn-item">üß™ –ó–µ–ª—å–µ</button>
            <button class="battle-btn" id="btn-flee">üèÉ –ë–µ–∂–∞—Ç—å</button>
        </div>
    </div>
    <div id="notification" style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,30,0.95); border: 2px solid #4a6fff; border-radius: 15px; padding: 15px 20px; color: white; font-weight: bold; z-index: 1000; display: none; pointer-events: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5);"></div>

    <script>
    // ========== –ù–ê–°–¢–†–û–ô–ö–ò ==========
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–æ–≤
    const isLocal = window.location.hostname.includes('localhost') || 
                    window.location.hostname.includes('127.0.0.1');
    
    const API_BASE = isLocal ? 'http://localhost:8000' : '';
    
    const SD_API = `${API_BASE}/sdapi/v1/txt2img`;
    const LLM_API = `${API_BASE}/v1/chat/completions`;
    
    console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ API:', { SD_API, LLM_API, isLocal });
    
    // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
    let tg = window.Telegram.WebApp;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram Web App
    tg.ready();
    tg.expand();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–µ—Ä—Å–∏—é Telegram Web App
    console.log('Telegram WebApp version:', tg.version);
    console.log('Platform:', tg.platform);
    
    // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø PHASER ==========
    const game = new Phaser.Game({
        type: Phaser.AUTO,
        parent: 'game-container',
        width: window.innerWidth,
        height: window.innerHeight,
        scene: { preload, create, update },
        scale: {
            mode: Phaser.Scale.RESIZE,
            autoCenter: Phaser.Scale.CENTER_BOTH
        },
        backgroundColor: '#0a0a1a',
        transparent: true
    });
    
    let sceneImage;
    let gameState = {
        history: [],
        inventory: ['–ó–µ–ª—å–µ –∑–¥–æ—Ä–æ–≤—å—è'],
        player: { hp: 100, maxHp: 100, attack: 10, defense: 5, level: 1, exp: 0 },
        currentBattle: null,
        quests: {
            main: {
                title: "–ü—Ä–æ–±—É–¥–∏—Ç—å –•—Ä–∞–Ω–∏—Ç–µ–ª—è –°–Ω–æ–≤",
                objectives: [
                    { text: "–ù–∞–π—Ç–∏ –ö—Ä–∞—Å–Ω—ã–π –ö—Ä–∏—Å—Ç–∞–ª–ª", done: false, keyword: "–∫—Ä–∞—Å–Ω—ã–π –∫—Ä–∏—Å—Ç–∞–ª–ª" },
                    { text: "–ù–∞–π—Ç–∏ –°–∏–Ω–∏–π –ö—Ä–∏—Å—Ç–∞–ª–ª", done: false, keyword: "—Å–∏–Ω–∏–π –∫—Ä–∏—Å—Ç–∞–ª–ª" },
                    { text: "–ù–∞–π—Ç–∏ –ó–µ–ª—ë–Ω—ã–π –ö—Ä–∏—Å—Ç–∞–ª–ª", done: false, keyword: "–∑–µ–ª–µ–Ω—ã–π –∫—Ä–∏—Å—Ç–∞–ª–ª" },
                    { text: "–ü—Ä–æ–≤–µ—Å—Ç–∏ —Ä–∏—Ç—É–∞–ª", done: false, keyword: "—Ä–∏—Ç—É–∞–ª" }
                ],
                completed: false
            },
            side: []
        }
    };
    
    // ========== –§–£–ù–ö–¶–ò–ò –ü–†–û–í–ï–†–ö–ò –°–ï–¢–ò ==========
    async function checkAPIs() {
        try {
            console.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ API...');
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä–∞
            const healthResp = await fetch(`${API_BASE}/health`, { timeout: 5000 });
            if (healthResp.ok) {
                const health = await healthResp.json();
                console.log('–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:', health);
                
                if (health.services.stable_diffusion === 'error') {
                    showNotification('‚ö†Ô∏è Stable Diffusion –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
                }
                if (health.services.lm_studio === 'error') {
                    showNotification('‚ö†Ô∏è LM Studio –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω');
                }
            }
            
            return true;
        } catch (error) {
            console.warn('–ü—Ä–æ–≤–µ—Ä–∫–∞ API –Ω–µ —É–¥–∞–ª–∞—Å—å:', error);
            return false;
        }
    }
    
    // ========== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ò–ì–†–´ ==========
    function preload() {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º placeholder –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        this.load.image('placeholder', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==');
    }
    
    function create() {
        // –°–æ–∑–¥–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        sceneImage = this.add.image(this.scale.width/2, this.scale.height/2, 'placeholder')
            .setScale(0.7)
            .setAlpha(0.3);
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        setupEventListeners();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º API
        checkAPIs().then(ok => {
            if (ok) {
                showNotification('‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –≥–æ—Ç–æ–≤—ã!');
            } else {
                showNotification('‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –Ω–µ–π—Ä–æ—Å–µ—Ç—è–º');
            }
        });
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        loadGame();
        
        updateUI();
        
        showNotification('üéÆ AI Dream Weaver –∑–∞–≥—Ä—É–∂–µ–Ω!');
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        setTimeout(async () => {
            try {
                await testAPIConnection();
            } catch (e) {
                console.log('–ê–≤—Ç–æ—Ç–µ—Å—Ç –ø—Ä–æ–ø—É—â–µ–Ω:', e.message);
            }
        }, 1000);
    }
    
    async function testAPIConnection() {
        console.log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API...');
        
        try {
            // –¢–µ—Å—Ç LM Studio
            const testPrompt = "–ü—Ä–∏–≤–µ—Ç! –û—Ç–≤–µ—Ç—å –∫–æ—Ä–æ—Ç–∫–æ 'OK' –µ—Å–ª–∏ —Ç—ã —Ä–∞–±–æ—Ç–∞–µ—à—å.";
            const llmTest = await askLLM(testPrompt);
            
            if (llmTest.includes('OK')) {
                console.log('‚úÖ LM Studio —Ä–∞–±–æ—Ç–∞–µ—Ç');
            }
            
            return true;
        } catch (error) {
            console.warn('‚ùå –¢–µ—Å—Ç API –Ω–µ –ø—Ä–æ–π–¥–µ–Ω:', error);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
            if (isLocal && window.location.href.includes('ngrok')) {
                showNotification('üîß –î–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —É–∫–∞–∂–∏ IP –ü–ö –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö');
                addStoryText(`<span style="color:#ffaa00">
                    <b>–í–∞–∂–Ω–æ!</b> –î–ª—è –∏–≥—Ä—ã —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞:<br>
                    1. –£–∑–Ω–∞–π IP –∫–æ–º–ø—å—é—Ç–µ—Ä–∞ (ipconfig)<br>
                    2. –ó–∞–º–µ–Ω–∏ –≤ –∫–æ–¥–µ localhost –Ω–∞ —ç—Ç–æ—Ç IP<br>
                    3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –∏–≥—Ä—É
                </span>`);
            }
            
            return false;
        }
    }
    
    function update() {
        // –ü—É—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏
    }
    
    function setupEventListeners() {
        const actionBtn = document.getElementById('action-btn');
        const userInput = document.getElementById('user-input');
        
        if (actionBtn) {
            actionBtn.addEventListener('click', handleUserAction);
        }
        
        if (userInput) {
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleUserAction();
            });
            
            userInput.addEventListener('input', () => {
                // –ê–≤—Ç–æ-—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –≤–≤–æ–¥–µ
                if (userInput.value.length > 10) {
                    saveGame();
                }
            });
        }
        
        // –ö–Ω–æ–ø–∫–∏ –±–æ—è
        document.getElementById('btn-attack')?.addEventListener('click', () => handleBattle('attack'));
        document.getElementById('btn-item')?.addEventListener('click', () => handleBattle('item'));
        document.getElementById('btn-flee')?.addEventListener('click', () => handleBattle('flee'));
        
        // –ö–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–∞–Ω–µ–ª–µ–π
        document.getElementById('toggle-inventory')?.addEventListener('click', () => togglePanel('inventory-panel'));
        document.getElementById('toggle-quests')?.addEventListener('click', () => togglePanel('quest-panel'));
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–µ–π –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
        document.addEventListener('click', (e) => {
            const panels = ['inventory-panel', 'quest-panel'];
            const toggles = ['toggle-inventory', 'toggle-quests'];
            
            if (!panels.some(id => document.getElementById(id)?.contains(e.target)) &&
                !toggles.some(id => document.getElementById(id)?.contains(e.target))) {
                panels.forEach(id => {
                    const panel = document.getElementById(id);
                    if (panel) panel.style.display = 'none';
                });
            }
        });
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        window.addEventListener('beforeunload', saveGame);
        
        // –ê–≤—Ç–æ-—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(saveGame, 30000);
    }
    
    async function handleUserAction() {
        const input = document.getElementById('user-input');
        const btn = document.getElementById('action-btn');
        const userText = input?.value.trim();
        
        if (!userText) {
            showNotification('‚úèÔ∏è –í–≤–µ–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ!');
            return;
        }
        
        btn.disabled = true;
        addStoryText(`<i>–í—ã: "${userText}"</i>`);
        
        clearChoiceButtons();
        
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º API –ø–µ—Ä–µ–¥ –¥–µ–π—Å—Ç–≤–∏–µ–º
            const apisOk = await checkAPIs();
            if (!apisOk) {
                throw new Error('–ù–µ–π—Ä–æ—Å–µ—Ç–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Stable Diffusion –∏ LM Studio.');
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ –±–æ—è
            if (await tryTriggerBattle(userText)) {
                input.value = '';
                btn.disabled = false;
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–µ—Å—Ç–æ–≤
            checkQuestProgress(userText);
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏
            const story = await askLLM(`–ò–≥—Ä–æ–∫ –≤ —Ñ—ç–Ω—Ç–µ–∑–∏-–º–∏—Ä–µ —Å–Ω–æ–≤. –î–µ–π—Å—Ç–≤–∏–µ: "${userText}". 
                –û–ø–∏—à–∏ –∫—Ä–∞—Ç–∫–æ (2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç. 
                –ó–∞—Ç–µ–º –ø—Ä–µ–¥–ª–æ–∂–∏ 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –¥–µ–π—Å—Ç–≤–∏–π (1. ... 2. ...).`);
            
            gameState.history.push(story);
            addStoryText(story);
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)
            generateImageAsync(`fantasy scene: ${userText}`).catch(e => {
                console.warn('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ:', e);
            });
            
            // –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞
            addChoiceButtons(story);
            
            // –°–ª—É—á–∞–π–Ω—ã–π –∫–≤–µ—Å—Ç
            if (Math.random() < 0.2) {
                addRandomQuest();
            }
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è:', error);
            addStoryText(`<span style="color:#ff8888">‚ùå –û—à–∏–±–∫–∞: ${error.message}</span>`);
            
            // –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º
            if (error.message.includes('fetch') || error.message.includes('network')) {
                addStoryText(`<span style="color:#ffaa00">
                    üí° <b>–°–æ–≤–µ—Ç:</b> –ï—Å–ª–∏ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã:<br>
                    1. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ Stable Diffusion –∏ LM Studio –∑–∞–ø—É—â–µ–Ω—ã<br>
                    2. –í –∫–æ–Ω—Å–æ–ª–∏ (F12) –ø–æ—Å–º–æ—Ç—Ä–∏ –æ—à–∏–±–∫–∏<br>
                    3. –î–ª—è –∏–≥—Ä—ã —Å —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —É–∫–∞–∂–∏ IP –∫–æ–º–ø—å—é—Ç–µ—Ä–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
                </span>`);
            }
        }
        
        saveGame();
        if (input) input.value = '';
        btn.disabled = false;
        updateUI();
    }
    
    async function askLLM(prompt) {
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000);
            
            const resp = await fetch(LLM_API, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    model: 'local-model',
                    messages: [{ role: 'user', content: prompt }],
                    temperature: 0.7,
                    max_tokens: 300
                }),
                signal: controller.signal
            });
            
            clearTimeout(timeoutId);
            
            if (!resp.ok) {
                const errorText = await resp.text();
                console.error('LLM Error Response:', errorText);
                
                // Fallback –æ—Ç–≤–µ—Ç
                return `–í—ã "${prompt.split('"')[1] || '–∏—Å—Å–ª–µ–¥—É–µ—Ç–µ'}" –º–∏—Ä —Å–Ω–æ–≤. –í—ã –º–æ–∂–µ—Ç–µ: 1. –ò–¥—Ç–∏ –¥–∞–ª—å—à–µ 2. –û—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è 3. –ò—Å–∫–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç—ã.`;
            }
            
            const data = await resp.json();
            return data.choices?.[0]?.message?.content || '–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç –Ω–µ–π—Ä–æ—Å–µ—Ç–∏.';
            
        } catch (error) {
            if (error.name === 'AbortError') {
                throw new Error('–¢–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ –∫ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ (30 —Å–µ–∫)');
            }
            throw error;
        }
    }
    
    async function generateImageAsync(prompt) {
        return new Promise(async (resolve, reject) => {
            try {
                showNotification('üñºÔ∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...');
                
                const resp = await fetch(SD_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt + ", fantasy art, digital painting, detailed",
                        negative_prompt: "blurry, ugly, text, watermark, signature",
                        steps: 15,
                        width: 512,
                        height: 384,
                        cfg_scale: 7
                    })
                });
                
                if (!resp.ok) {
                    const errorText = await resp.text();
                    console.error('SD Error:', errorText);
                    reject(new Error('Stable Diffusion –æ—à–∏–±–∫–∞'));
                    return;
                }
                
                const data = await resp.json();
                
                if (!data.images?.[0]) {
                    reject(new Error('–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –æ—Ç–≤–µ—Ç–µ'));
                    return;
                }
                
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                img.onload = () => {
                    const scene = game.scene.scenes[0];
                    
                    if (scene.textures.exists('current')) {
                        scene.textures.get('current').setSource(img);
                    } else {
                        scene.textures.addImage('current', img);
                    }
                    
                    if (sceneImage) {
                        sceneImage.setTexture('current');
                        sceneImage.setAlpha(1);
                    }
                    
                    showNotification('‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ!');
                    resolve();
                };
                
                img.onerror = () => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                    showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                    reject(new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è'));
                };
                
                img.src = `data:image/png;base64,${data.images[0]}`;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏');
                reject(error);
            }
        });
    }
    
    // ========== –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
    
    function togglePanel(panelId) {
        const panel = document.getElementById(panelId);
        if (!panel) return;
        
        const isVisible = panel.style.display === 'block';
        panel.style.display = isVisible ? 'none' : 'block';
        
        // –°–∫—Ä—ã–≤–∞–µ–º –¥—Ä—É–≥–∏–µ –ø–∞–Ω–µ–ª–∏
        const otherId = panelId === 'inventory-panel' ? 'quest-panel' : 'inventory-panel';
        const otherPanel = document.getElementById(otherId);
        if (otherPanel) otherPanel.style.display = 'none';
    }
    
    function addStoryText(text) {
        const panel = document.getElementById('story-text');
        if (panel) {
            panel.innerHTML += '<br>' + text;
            panel.scrollTop = panel.scrollHeight;
        }
    }
    
    function clearChoiceButtons() {
        document.querySelectorAll('.choice-btn').forEach(btn => btn.remove());
    }
    
    function addChoiceButtons(storyText) {
        clearChoiceButtons();
        
        const choices = storyText.match(/\d\.\s+([^\n]+)/g);
        if (!choices) return;
        
        choices.forEach((choice, idx) => {
            setTimeout(() => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.textContent = choice.replace(/^\d\.\s+/, '');
                btn.onclick = () => {
                    const input = document.getElementById('user-input');
                    if (input) {
                        input.value = btn.textContent;
                        handleUserAction();
                    }
                };
                document.body.appendChild(btn);
            }, idx * 100);
        });
    }
    
    function showNotification(text) {
        const notification = document.getElementById('notification');
        if (!notification) return;
        
        notification.textContent = text;
        notification.style.display = 'block';
        
        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    }
    
    // ========== –°–ò–°–¢–ï–ú–ê –°–û–•–†–ê–ù–ï–ù–ò–ô ==========
    
    function saveGame() {
        try {
            localStorage.setItem('dreamWeaverSave', JSON.stringify(gameState));
            console.log('–ò–≥—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
        }
    }
    
    function loadGame() {
        try {
            const saved = localStorage.getItem('dreamWeaverSave');
            if (saved) {
                const parsed = JSON.parse(saved);
                Object.assign(gameState, parsed);
                showNotification('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ');
                console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', parsed);
            }
        } catch (e) {
            console.warn('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
        }
    }
    
    // ========== –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
    
    // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–±–æ–∏, –∫–≤–µ—Å—Ç—ã, UI) –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ...
    // (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–∞—à —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –¥–ª—è handleBattle, tryTriggerBattle, updateUI –∏ —Ç.–¥.)
    
    // –í –∫–æ–Ω—Ü–µ –¥–æ–±–∞–≤—å—Ç–µ:
    console.log('AI Dream Weaver –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    console.log('Telegram User:', tg.initDataUnsafe?.user);
</script>
</body>
</html>