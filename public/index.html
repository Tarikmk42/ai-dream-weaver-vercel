<script>
    // ========== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø API ==========
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ä–µ–¥—ã
    const isLocalhost = window.location.hostname === 'localhost' || 
                        window.location.hostname === '127.0.0.1';
    
    const API_BASE = isLocalhost ? 'http://localhost:3000' : '';
    
    const SD_API = `${API_BASE}/api/sd-proxy`;
    const LLM_API = `${API_BASE}/api/llm-proxy`;
    const HEALTH_API = `${API_BASE}/api/health`;
    
    console.log('Environment:', {
        isLocalhost,
        API_BASE,
        SD_API,
        LLM_API,
        location: window.location.href
    });

    // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
    document.addEventListener('DOMContentLoaded', async () => {
        console.log('AI Dream Weaver starting...');
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram
        if (window.Telegram?.WebApp) {
            try {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                console.log('Telegram Web App initialized');
            } catch (e) {
                console.log('Telegram not available:', e);
            }
        }
        
        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API
        await testAPI();
        
        // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
        setTimeout(() => {
            const loader = document.getElementById('loader');
            if (loader) {
                loader.style.transition = 'opacity 0.5s';
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 500);
            }
            showNotification('üéÆ –ò–≥—Ä–∞ –≥–æ—Ç–æ–≤–∞! –ù–∞—á–Ω–∏—Ç–µ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–µ.');
        }, 1000);
        
        // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        setTimeout(() => {
            const input = document.getElementById('user-input');
            if (input) input.focus();
        }, 200);
    });

    // ========== –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï API ==========
    async function testAPI() {
        try {
            console.log('Testing API connection...');
            
            const response = await fetch(HEALTH_API);
            const data = await response.json();
            
            console.log('API Status:', data);
            
            if (response.ok) {
                showNotification('‚úÖ API –ø–æ–¥–∫–ª—é—á–µ–Ω–æ', 2000);
            }
            
        } catch (error) {
            console.warn('API test failed:', error);
            showNotification('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º', 3000);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            addStoryText(`<div style="color:#ffaa00; padding:10px; background:rgba(255,170,0,0.1); border-radius:10px;">
                <strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong> –ò–≥—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ä–µ–∂–∏–º–µ.<br>
                –î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–µ–π—Ä–æ—Å–µ—Ç–µ–π –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ API –≤ Vercel.
            </div>`);
        }
    }

    // ========== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
    async function handleUserAction() {
        const input = document.getElementById('user-input');
        const btn = document.getElementById('action-btn');
        const text = input?.value.trim();
        
        if (!text) {
            showNotification('‚úèÔ∏è –í–≤–µ–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ!');
            return;
        }
        
        if (btn) btn.disabled = true;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
        addStoryText(`<div style="color:#88ff88; margin:10px 0;"><strong>üë§ –í—ã:</strong> ${text}</div>`);
        
        try {
            // –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç AI
            const story = await askLLM(text);
            addStoryText(story);
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            setTimeout(() => {
                generateImage(text).catch(e => console.log('Image skipped:', e));
            }, 500);
            
        } catch (error) {
            console.error('Action error:', error);
            addStoryText(`<div style="color:#ff8888;">–û—à–∏–±–∫–∞: ${error.message}</div>`);
            
            // Fallback –æ—Ç–≤–µ—Ç
            const fallback = `–í—ã "${text}" –≤ –º–∏—Ä–µ —Å–Ω–æ–≤. –ß—Ç–æ –±—É–¥–µ—Ç–µ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ?<br><br>
            1. –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –¥–∞–ª—å—à–µ<br>
            2. –û—Å–º–æ—Ç—Ä–µ—Ç—å—Å—è –≤–æ–∫—Ä—É–≥<br>
            3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å<br>
            4. –ò—Å–∫–∞—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏`;
            
            addStoryText(fallback);
            
        } finally {
            if (btn) btn.disabled = false;
            if (input) {
                input.value = '';
                input.focus();
            }
        }
    }

    async function askLLM(prompt) {
        const response = await fetch(LLM_API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                model: 'local-model',
                messages: [
                    {
                        role: 'system',
                        content: '–¢—ã –º–∞—Å—Ç–µ—Ä –ø–æ–≤–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –≤ —Ñ—ç–Ω—Ç–µ–∑–∏-–º–∏—Ä–µ —Å–Ω–æ–≤. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–æ. –ü–æ—Å–ª–µ –æ–ø–∏—Å–∞–Ω–∏—è –ø—Ä–µ–¥–ª–æ–∂–∏ 3-4 –≤–∞—Ä–∏–∞–Ω—Ç–∞ –¥–µ–π—Å—Ç–≤–∏–π, –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–≤ –∏—Ö.'
                    },
                    {
                        role: 'user',
                        content: `–ò–≥—Ä–æ–∫ –≤ —Ñ—ç–Ω—Ç–µ–∑–∏-–º–∏—Ä–µ —Å–Ω–æ–≤. –î–µ–π—Å—Ç–≤–∏–µ –∏–≥—Ä–æ–∫–∞: "${prompt}". –û–ø–∏—à–∏ —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–µ–π—Å—Ç–≤–∏–π.`
                    }
                ],
                temperature: 0.8,
                max_tokens: 400
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'API error');
        }
        
        const data = await response.json();
        return data.choices[0].message.content;
    }

    async function generateImage(prompt) {
        showNotification('üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è...');
        
        const response = await fetch(SD_API, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                prompt: prompt + ", fantasy art, dream world, magical, detailed",
                steps: 20,
                width: 512,
                height: 384
            })
        });
        
        if (!response.ok) {
            throw new Error('Image generation failed');
        }
        
        const data = await response.json();
        showNotification('‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ!');
        
        console.log('Image data:', data);
        // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    }

    // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
    function addStoryText(html) {
        const panel = document.getElementById('story-text');
        if (panel) {
            panel.innerHTML += '<div style="margin: 15px 0;">' + html + '</div>';
            panel.scrollTop = panel.scrollHeight;
        }
    }

    function showNotification(text, duration = 3000) {
        const el = document.getElementById('notification');
        if (!el) return;
        
        el.textContent = text;
        el.style.display = 'block';
        
        setTimeout(() => {
            el.style.display = 'none';
        }, duration);
    }

    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    window.AIDreamWeaver = {
        testAPI,
        handleUserAction,
        showNotification
    };
</script>
